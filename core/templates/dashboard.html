{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-dark">Welcome to Intellidebt Manager</h2>
        <p class="text-muted">Loan Management System Dashboard</p>
    </div>
    <div class="col-md-4">
        <form method="get" action="{% url 'dashboard' %}">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                <input type="text" name="q" class="form-control border-start-0" placeholder="Search Client Name, ID, or Phone..." value="{{ query|default:'' }}">
                <button class="btn btn-primary" type="submit">Search</button>
            </div>
        </form>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 p-3">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="text-muted text-uppercase small fw-bold">Total Loans</h6>
                    <h3 class="fw-bold mb-0">{{ total_loans }}</h3>
                </div>
                <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                    <i class="bi bi-wallet2 fs-4"></i>
                </div>
            </div>
            <div class="mt-3">
                <a href="{% url 'loan_list' %}" class="btn btn-sm btn-outline-primary w-100">View All Loans <i class="bi bi-arrow-right"></i></a>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 p-3">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="text-muted text-uppercase small fw-bold">Active Loans</h6>
                    <h3 class="fw-bold mb-0">{{ active_loans_count }}</h3>
                    <small class="text-danger fw-bold"><i class="bi bi-exclamation-circle"></i> {{ active_defaults }} Overdue</small>
                </div>
                <div class="bg-info bg-opacity-10 p-3 rounded-circle text-info">
                    <i class="bi bi-person-check fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card ai-card p-3 h-100 shadow-sm border-0">
            <div class="d-flex justify-content-between align-items-center position-relative" style="z-index: 2;">
                <div>
                    <h6 class="text-uppercase mb-1 small fw-bold" style="opacity: 0.8;">AI Risk Scan</h6>
                    <h3 class="fw-bold mb-0">Active</h3>
                </div>
                <div class="rounded-circle p-3" style="background: rgba(255,255,255,0.1);">
                    <i class="bi bi-stars fs-4"></i>
                </div>
            </div>
            <div class="mt-3 position-relative" style="z-index: 2;">
                <a href="{% url 'analytics' %}" class="text-white text-decoration-none small">View Live Predictions &rarr;</a>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 p-3">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="text-muted text-uppercase small fw-bold">Total Disbursed</h6>
                    <h3 class="fw-bold mb-0 text-success">KES {{ total_disbursed|floatformat:0|intcomma }}</h3>
                </div>
                <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                    <i class="bi bi-cash-stack fs-4"></i>
                </div>
            </div>
            <small class="text-muted mt-2 d-block">Lifetime Disbursement</small>
        </div>
    </div>
</div>

{% if query %}
    <div class="card shadow-sm border-0 mb-4 border-primary border-top border-3">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold text-primary">
                <i class="bi bi-search me-2"></i> Search Results for "{{ query }}"
            </h5>
            <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary">Clear Search</a>
        </div>
        <div class="card-body p-0">
            {% if search_results %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Client Name</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Outstanding (KES)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for loan in search_results %}
                            <tr>
                                <td><span class="badge bg-secondary">#{{ loan.id }}</span></td>
                                <td class="fw-semibold">{{ loan.client.name }}</td>
                                <td>{{ loan.client.phone_number|default:"N/A" }}</td>
                                <td>
                                    {% if loan.status == 'Active' %}
                                        <span class="badge bg-primary bg-opacity-10 text-primary">Active</span>
                                    {% elif loan.status == 'Defaulted' %}
                                        <span class="badge bg-danger bg-opacity-10 text-danger">Defaulted</span>
                                    {% else %}
                                        <span class="badge bg-success bg-opacity-10 text-success">Paid</span>
                                    {% endif %}
                                </td>
                                <td>{{ loan.outstanding_amount|floatformat:0|intcomma }}</td>
                                <td>
                                    <a href="{% url 'loan_detail' loan.id %}" class="btn btn-sm btn-primary">
                                        Select Profile
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="p-5 text-center text-muted">
                    <i class="bi bi-exclamation-circle display-4 mb-3"></i>
                    <h5>No loans or clients found matching "{{ query }}"</h5>
                    <p>Try searching by a different name, loan ID, or phone number.</p>
                </div>
            {% endif %}
        </div>
    </div>

{% else %}
    <div class="row g-3">
        <div class="col-lg-8">
            <div class="card mb-3 shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark">Loan Performance</h6>
                    <div class="small">
                        <span class="badge bg-primary bg-opacity-10 text-primary me-2"><i class="bi bi-circle-fill me-1"></i> Repaid</span>
                        <span class="badge bg-danger bg-opacity-10 text-danger"><i class="bi bi-circle-fill me-1"></i> Overdue Trend</span>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="loanPerformanceChart" height="280"></canvas>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold">Client Segmentation (ML Clustering)</h6>
                </div>
                <div class="card-body">
                    <canvas id="segmentChart" height="250"></canvas>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold">Quick Actions</h6>
                </div>
                <div class="card-body d-flex gap-3">
                    <a href="{% url 'create_loan' %}" class="btn btn-success flex-fill py-2">
                        <i class="bi bi-plus-circle me-2"></i> New Loan Application
                    </a>
                    <a href="{% url 'trigger_reminders' %}" class="btn btn-warning flex-fill py-2 text-dark">
                        <i class="bi bi-bell me-2"></i> Run Automated Reminders
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold">Recent Applications</h6>
                    <a href="{% url 'loan_list' %}" class="btn btn-sm btn-light text-primary fw-bold small">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 card-table">
                            <thead class="table-light small text-muted text-uppercase">
                                <tr>
                                    <th>Applicant</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for loan in recent_loans %}
                                <tr>
                                    <td class="fw-bold">{{ loan.client.name }}</td>
                                    <td>KES {{ loan.amount|floatformat:0|intcomma }}</td>
                                    <td>
                                        <span class="badge small {% if loan.status == 'Active' %}bg-primary{% elif loan.status == 'Defaulted' %}bg-danger{% else %}bg-success{% endif %}">
                                            {{ loan.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="3" class="text-center text-muted py-3">No recent loans.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold">Loan Status Overview</h6>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% if not query %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 1. Client Segmentation Chart
    const ctxSegment = document.getElementById('segmentChart').getContext('2d');
    const rawData = '{{ segment_data|default:"{}"|safe }}';
    const segmentData = JSON.parse(rawData);
    
    new Chart(ctxSegment, {
        type: 'doughnut',
        data: {
            labels: Object.keys(segmentData),
            datasets: [{
                data: Object.values(segmentData),
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '70%',
            plugins: { legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } }
        }
    });

    // 2. Loan Status Overview Chart
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    const rawStatusData = '{{ status_data|default:"{}"|safe }}';
    const statusDataMap = JSON.parse(rawStatusData);
    
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusDataMap),
            datasets: [{
                data: Object.values(statusDataMap),
                backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '60%',
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, usePointStyle: true } } }
        }
    });

    // 3. Loan Performance Chart (Bar + Line Combo)
    const ctxPerformance = document.getElementById('loanPerformanceChart').getContext('2d');
    new Chart(ctxPerformance, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
            datasets: [{
                label: 'Repaid',
                data: [120, 150, 180, 200, 170, 210, 230], // Placeholder data
                backgroundColor: '#3b82f6',
                borderRadius: 4,
                barPercentage: 0.6,
                order: 2
            }, {
                label: 'Overdue Trend',
                type: 'line',
                data: [30, 50, 40, 60, 45, 70, 55], // Placeholder data
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                order: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endif %}

<style>
    /* Custom styling */
    .card-table thead th { border-top: none; border-bottom-width: 1px; font-weight: 600; }
    .card-table tbody td:first-child { padding-left: 1.5rem; }
    .card-table tbody td:last-child { padding-right: 1.5rem; }
    .ai-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border: 1px solid #7c3aed; }
</style>
{% endblock %}